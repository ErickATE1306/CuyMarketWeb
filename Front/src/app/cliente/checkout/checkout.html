<div class="checkout-container">
	<div class="checkout-header">
		<div class="container">
			<h1>Finalizar Compra</h1>
			<div class="checkout-steps">
				<div class="step" [class.active]="currentStep === 1" [class.completed]="currentStep > 1"
					(click)="goToStep(1)">
					<div class="step-number">1</div>
					<div class="step-label">Envío</div>
				</div>
				<div class="step-divider"></div>
				<div class="step" [class.active]="currentStep === 2" [class.completed]="currentStep > 2"
					(click)="goToStep(2)">
					<div class="step-number">2</div>
					<div class="step-label">Pago</div>
				</div>
				<div class="step-divider"></div>
				<div class="step" [class.active]="currentStep === 3">
					<div class="step-number">3</div>
					<div class="step-label">Confirmación</div>
				</div>
			</div>
		</div>
	</div>

	<div class="checkout-content container">
		<div class="checkout-main">
			<!-- PASO 1: INFORMACIÓN DE ENVÍO -->
			@if (currentStep === 1) {
			<div class="checkout-section">
				<h2>Información de Envío</h2>
				<form class="form-grid">
					<div class="form-group">
						<label>Nombre *</label>
						<input type="text" [(ngModel)]="shippingInfo.nombre" name="nombre" placeholder="Tu nombre"
							required>
					</div>
					<div class="form-group">
						<label>Apellido *</label>
						<input type="text" [(ngModel)]="shippingInfo.apellido" name="apellido" placeholder="Tu apellido"
							required>
					</div>
					<div class="form-group">
						<label>Correo Electrónico *</label>
						<input type="email" [(ngModel)]="shippingInfo.email" name="email" placeholder="tu@email.com"
							required>
					</div>
					<div class="form-group">
						<label>Teléfono *</label>
						<input type="tel" [(ngModel)]="shippingInfo.telefono" name="telefono" placeholder="999 999 999"
							required>
					</div>
					<div class="form-group">
						<label>DNI *</label>
						<input type="text" [(ngModel)]="shippingInfo.dni" name="dni" placeholder="12345678"
							maxlength="8" required>
					</div>
					<div class="form-group">
						<label>Ciudad *</label>
						<input type="text" [(ngModel)]="shippingInfo.ciudad" name="ciudad"
							placeholder="Ej: Lima" required>
					</div>
					<div class="form-group">
						<label>Distrito *</label>
						<input type="text" [(ngModel)]="shippingInfo.distrito" name="distrito"
							placeholder="Ej: San Isidro" required>
					</div>
					<div class="form-group">
						<label>Código Postal</label>
						<input type="text" [(ngModel)]="shippingInfo.codigoPostal" name="codigoPostal"
							placeholder="15001" maxlength="10">
					</div>
					<div class="form-group full-width">
						<label>Dirección Completa *</label>
						<input type="text" [(ngModel)]="shippingInfo.direccion" name="direccion"
							placeholder="Av/Jr/Calle, número, interior, etc." required>
					</div>
					<div class="form-group full-width">
						<label>Referencia</label>
						<input type="text" [(ngModel)]="shippingInfo.referencia" name="referencia"
							placeholder="Cerca a..., frente a..., etc.">
					</div>
				</form>
				<div class="actions">
					<button class="btn-primary" (click)="nextStep()" [disabled]="!validateShipping()">
						Continuar al Pago
						<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
							stroke-width="2">
							<polyline points="9 18 15 12 9 6" />
						</svg>
					</button>
				</div>
			</div>
			}

			<!-- PASO 2: MÉTODO DE PAGO -->
			@if (currentStep === 2) {
			<div class="checkout-section">
				<h2>Método de Pago</h2>

				<div class="payment-methods">
					<div class="payment-method" [class.active]="paymentMethod === 'tarjeta'"
						(click)="paymentMethod = 'tarjeta'">
						<input type="radio" name="payment" [checked]="paymentMethod === 'tarjeta'" id="tarjeta">
						<label for="tarjeta">
							<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
								stroke-width="2">
								<rect x="1" y="4" width="22" height="16" rx="2" />
								<line x1="1" y1="10" x2="23" y2="10" />
							</svg>
							<span>Tarjeta de Crédito/Débito</span>
						</label>
					</div>
					<div class="payment-method" [class.active]="paymentMethod === 'yape'"
						(click)="paymentMethod = 'yape'">
						<input type="radio" name="payment" [checked]="paymentMethod === 'yape'" id="yape">
						<label for="yape">
							<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
								stroke-width="2">
								<rect x="5" y="2" width="14" height="20" rx="2" />
								<line x1="12" y1="18" x2="12" y2="18" />
							</svg>
							<span>Yape</span>
						</label>
					</div>
					<div class="payment-method" [class.active]="paymentMethod === 'plin'"
						(click)="paymentMethod = 'plin'">
						<input type="radio" name="payment" [checked]="paymentMethod === 'plin'" id="plin">
						<label for="plin">
							<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
								stroke-width="2">
								<rect x="5" y="2" width="14" height="20" rx="2" />
								<line x1="12" y1="18" x2="12" y2="18" />
							</svg>
							<span>Plin</span>
						</label>
					</div>
					<div class="payment-method" [class.active]="paymentMethod === 'transferencia'"
						(click)="paymentMethod = 'transferencia'">
						<input type="radio" name="payment" [checked]="paymentMethod === 'transferencia'"
							id="transferencia">
						<label for="transferencia">
							<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
								stroke-width="2">
								<line x1="12" y1="1" x2="12" y2="23" />
								<path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />
							</svg>
							<span>Transferencia Bancaria</span>
						</label>
					</div>
				</div>

				<!-- FORMULARIO TARJETA -->
				@if (paymentMethod === 'tarjeta') {
				<div class="payment-form">
					<div class="form-group">
						<label>Número de Tarjeta *</label>
						<input type="text" [(ngModel)]="cardInfo.numero" name="cardNumber"
							placeholder="1234 5678 9012 3456" maxlength="19" (input)="formatCardNumber($event)"
							required>
					</div>
					<div class="form-group">
						<label>Nombre del Titular *</label>
						<input type="text" [(ngModel)]="cardInfo.titular" name="cardHolder"
							placeholder="Como aparece en la tarjeta" required>
					</div>
					<div class="form-row">
						<div class="form-group">
							<label>Fecha de Vencimiento *</label>
							<input type="text" [(ngModel)]="cardInfo.vencimiento" name="expiry" placeholder="MM/YY"
								maxlength="5" (input)="formatExpiry($event)" required>
						</div>
						<div class="form-group">
							<label>CVV *</label>
							<input type="text" [(ngModel)]="cardInfo.cvv" name="cvv" placeholder="123" maxlength="3"
								required>
						</div>
					</div>
					<div class="secure-payment">
						<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
							stroke-width="2">
							<rect x="3" y="11" width="18" height="11" rx="2" />
							<path d="M7 11V7a5 5 0 0 1 10 0v4" />
						</svg>
						<span>Pago seguro encriptado con SSL</span>
					</div>
				</div>
				}

				<!-- FORMULARIO YAPE/PLIN -->
				@if (paymentMethod === 'yape' || paymentMethod === 'plin') {
				<div class="payment-form">
					<div class="qr-section">
						<div class="qr-code">
							<img src="/assets/images/placeholder.png" alt="QR Code">
						</div>
						<div class="qr-info">
							<h3>Escanea el código QR</h3>
							<p>Abre tu app de {{ paymentMethod === 'yape' ? 'Yape' : 'Plin' }} y escanea este código</p>
							<div class="amount-box">
								<span class="amount-label">Monto a pagar:</span>
								<span class="amount-value">S/ {{ getTotal().toFixed(2) }}</span>
							</div>
						</div>
					</div>
					<div class="form-group">
						<label>Número de Teléfono Asociado *</label>
						<input type="tel" [(ngModel)]="yapeInfo.telefono" name="yapePhone" placeholder="999 999 999"
							required>
					</div>
					<div class="form-group">
						<label>Captura de Pantalla del Comprobante *</label>
						<input type="file" (change)="onFileSelected($event, 'yape')" accept="image/*" required>
						<small>Sube una captura de pantalla de tu comprobante de pago</small>
					</div>
				</div>
				}

				<!-- FORMULARIO TRANSFERENCIA -->
				@if (paymentMethod === 'transferencia') {
				<div class="payment-form">
					<div class="bank-info">
						<h3>Datos Bancarios</h3>
						<div class="bank-details">
							<div class="detail-row">
								<span class="label">Banco:</span>
								<span class="value">BCP</span>
							</div>
							<div class="detail-row">
								<span class="label">Cuenta Corriente:</span>
								<span class="value">194-123456789-0-12</span>
							</div>
							<div class="detail-row">
								<span class="label">CCI:</span>
								<span class="value">002-194-123456789012-34</span>
							</div>
							<div class="detail-row">
								<span class="label">Titular:</span>
								<span class="value">La Cuyería Premium S.A.C.</span>
							</div>
							<div class="detail-row highlight">
								<span class="label">Monto a transferir:</span>
								<span class="value">S/ {{ getTotal().toFixed(2) }}</span>
							</div>
						</div>
					</div>
					<div class="form-group">
						<label>Comprobante de Transferencia *</label>
						<input type="file" (change)="onFileSelected($event, 'transfer')"
							accept="image/*,application/pdf" required>
						<small>Sube una foto o PDF de tu comprobante de transferencia</small>
					</div>
				</div>
				}

				<div class="actions">
					<button class="btn-secondary" (click)="prevStep()">
						<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
							stroke-width="2">
							<polyline points="15 18 9 12 15 6" />
						</svg>
						Volver
					</button>
					<button class="btn-primary" (click)="nextStep()" [disabled]="!validatePayment()">
						Continuar a Confirmación
						<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
							stroke-width="2">
							<polyline points="9 18 15 12 9 6" />
						</svg>
					</button>
				</div>
			</div>
			}

			<!-- PASO 3: CONFIRMACIÓN -->
			@if (currentStep === 3) {
			<div class="checkout-section">
				<h2>Confirmar Pedido</h2>

				<div class="confirmation-section">
					<h3>Información de Envío</h3>
					<div class="info-card">
						<p><strong>{{ shippingInfo.nombre }} {{ shippingInfo.apellido }}</strong></p>
						<p>{{ shippingInfo.email }}</p>
						<p>{{ shippingInfo.telefono }}</p>
						<p>{{ shippingInfo.direccion }}</p>
						<p>{{ shippingInfo.distrito }}, {{ shippingInfo.ciudad }}</p>
						@if (shippingInfo.referencia) {
						<p class="ref">Ref: {{ shippingInfo.referencia }}</p>
						}
						<button class="btn-edit" (click)="goToStep(1)">Editar</button>
					</div>
				</div>

				<div class="confirmation-section">
					<h3>Método de Pago</h3>
					<div class="info-card">
						@if (paymentMethod === 'tarjeta') {
						<p><strong>Tarjeta de Crédito/Débito</strong></p>
						<p>**** **** **** {{ cardInfo.numero.slice(-4) }}</p>
						<p>{{ cardInfo.titular }}</p>
						}
						@if (paymentMethod === 'yape') {
						<p><strong>Yape</strong></p>
						<p>{{ yapeInfo.telefono }}</p>
						}
						@if (paymentMethod === 'plin') {
						<p><strong>Plin</strong></p>
						<p>{{ yapeInfo.telefono }}</p>
						}
						@if (paymentMethod === 'transferencia') {
						<p><strong>Transferencia Bancaria</strong></p>
						<p>BCP - {{ transferInfo.banco }}</p>
						}
						<button class="btn-edit" (click)="goToStep(2)">Editar</button>
					</div>
				</div>

				<div class="confirmation-section">
					<h3>Productos</h3>
					<div class="products-list">
						@for (item of cartItems; track item.id) {
						<div class="product-item">
							<div class="product-info">
								<h4>{{ item.producto ? item.producto.nombre : 'Producto' }}</h4>
								<p>{{ item.producto ? item.producto.categoriaNombre : '' }} • {{ item.producto ? item.producto.peso : '' }}</p>
							</div>
							<div class="product-qty">x{{ item.cantidad }}</div>
							<div class="product-price">S/ {{ item.producto ? (item.producto.precio * item.cantidad).toFixed(2) : '0.00' }}</div>
						</div>
						}
					</div>
				</div>

				<div class="terms-section">
					<label class="checkbox-label">
						<input type="checkbox" [(ngModel)]="acceptTerms" name="terms">
						<span>Acepto los <a href="/terminos" target="_blank">términos y condiciones</a> y la <a
								href="/privacidad" target="_blank">política de privacidad</a></span>
					</label>
				</div>

				<div class="actions">
					<button class="btn-secondary" (click)="prevStep()">
						<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
							stroke-width="2">
							<polyline points="15 18 9 12 15 6" />
						</svg>
						Volver
					</button>
					<button class="btn-primary" (click)="processPayment()"
						[disabled]="!acceptTerms || processingPayment">
						@if (processingPayment) {
						<span class="spinner"></span>
						Procesando...
						} @else {
						Confirmar y Pagar S/ {{ getTotal().toFixed(2) }}
						}
					</button>
				</div>
			</div>
			}
		</div>

		<!-- RESUMEN DEL PEDIDO (SIDEBAR) -->
		<div class="order-summary">
			<div class="summary-card">
				<h3>Resumen del Pedido</h3>
				<div class="summary-items">
					@for (item of cartItems; track item.id) {
					<div class="summary-item">
						<span class="item-name">{{ item.producto ? item.producto.nombre : 'Producto' }} (x{{ item.cantidad }})</span>
						<span class="item-price">S/ {{ item.producto ? (item.producto.precio * item.cantidad).toFixed(2) : '0.00' }}</span>
					</div>
					}
				</div>
				<div class="summary-divider"></div>
				<div class="summary-row">
					<span>Subtotal</span>
					<span>S/ {{ getSubtotal().toFixed(2) }}</span>
				</div>
				<div class="summary-row">
					<span>Envío</span>
					<span>S/ {{ getEnvio().toFixed(2) }}</span>
				</div>
				@if (discountAmount > 0) {
				<div class="summary-row discount">
					<span>Descuento</span>
					<span>-S/ {{ discountAmount.toFixed(2) }}</span>
				</div>
				}
				<div class="summary-divider"></div>

				<!-- Cupón de descuento -->
				<app-entrada-cupon [cartTotal]="getSubtotal()"
					(couponApplied)="onCouponApplied($event)"></app-entrada-cupon>

				<div class="summary-row total">
					<span>Total</span>
					<span>S/ {{ getTotal().toFixed(2) }}</span>
				</div>
			</div>

			<div class="security-badges">
				<div class="badge">
					<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<rect x="3" y="11" width="18" height="11" rx="2" />
						<path d="M7 11V7a5 5 0 0 1 10 0v4" />
					</svg>
					<span>Pago Seguro</span>
				</div>
				<div class="badge">
					<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
					</svg>
					<span>Compra Protegida</span>
				</div>
			</div>
		</div>
	</div>
</div>