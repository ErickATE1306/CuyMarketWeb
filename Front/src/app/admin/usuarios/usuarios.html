<div class="dashboard-content">
    <div class="page-header">
        <h2>Gesti√≥n de Usuarios</h2>
        <button class="btn-primary" (click)="openModal()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19" />
                <line x1="5" y1="12" x2="19" y2="12" />
            </svg>
            Nuevo Usuario
        </button>
    </div>

    <!-- Stats -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                    <circle cx="9" cy="7" r="4" />
                </svg>
            </div>
            <div class="stat-content">
                <span class="stat-label">Total Usuarios</span>
                <span class="stat-value">{{ totalUsuarios }}</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
                    <circle cx="9" cy="7" r="4" />
                    <path d="M22 21v-2a4 4 0 0 0-3-3.87" />
                    <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                </svg>
            </div>
            <div class="stat-content">
                <span class="stat-label">Activos</span>
                <span class="stat-value">{{ activos }}</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
                    <circle cx="9" cy="7" r="4" />
                    <line x1="17" y1="11" x2="23" y2="11" />
                </svg>
            </div>
            <div class="stat-content">
                <span class="stat-label">Nuevos (mes)</span>
                <span class="stat-value">{{ nuevosMes }}</span>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="filters-bar">
        <div class="filter-group">
            <button class="filter-btn" [class.active]="currentFilter === 'Todos'"
                (click)="filterUsuarios('Todos')">Todos</button>
            <button class="filter-btn" [class.active]="currentFilter === 'Clientes'"
                (click)="filterUsuarios('Clientes')">Clientes</button>
            <button class="filter-btn" [class.active]="currentFilter === 'Empleados'"
                (click)="filterUsuarios('Empleados')">Empleados</button>
            <button class="filter-btn" [class.active]="currentFilter === 'Admins'"
                (click)="filterUsuarios('Admins')">Admins</button>
        </div>
        <div class="search-box">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8" />
                <path d="m21 21-4.35-4.35" />
            </svg>
            <input type="text" placeholder="Buscar usuario..." [(ngModel)]="searchTerm"
                (input)="filterUsuarios(currentFilter)">
        </div>
    </div>

    <!-- Users Table -->
    <div class="table-card">
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" style="color: #6b7280;">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                <circle cx="9" cy="7" r="4"></circle>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                            </svg>
                        </th>
                        <th>Usuario</th>
                        <th>Email</th>
                        <th>Rol</th>
                        <th>Fecha Registro</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let user of filteredUsuarios">
                        <td>
                            <div class="user-icon-cell">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2" style="color: #9ca3af;">
                                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                    <circle cx="12" cy="7" r="4"></circle>
                                </svg>
                            </div>
                        </td>
                        <td>
                            <div class="customer-info">
                                <div class="customer-avatar">{{ user.nombre.charAt(0) }}{{ user.apellido.charAt(0) }}
                                </div>
                                <div>
                                    <div class="customer-name">{{ user.nombre }} {{ user.apellido }}</div>
                                    <div class="customer-phone">{{ user.telefono }}</div>
                                </div>
                            </div>
                        </td>
                        <td>{{ user.email }}</td>
                        <td>
                            <span class="role-badge" [ngClass]="getRolBadgeClass(user.roles)">
                                {{ getRolDisplay(user.roles) }}
                            </span>
                        </td>
                        <td>{{ user.fechaRegistro | date:'dd/MM/yyyy' }}</td>
                        <td>
                            <span class="status-badge" [class.completed]="user.activo" [class.cancelled]="!user.activo">
                                {{ user.activo ? 'Activo' : 'Inactivo' }}
                            </span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-icon" title="Editar" (click)="openEditModal(user)">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
                                    </svg>
                                </button>
                                <button class="btn-icon" title="Eliminar" (click)="deleteUser(user.id)">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <polyline points="3 6 5 6 21 6" />
                                        <path
                                            d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
                                    </svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                    <tr *ngIf="filteredUsuarios.length === 0">
                        <td colspan="7" class="text-center">No se encontraron usuarios</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal Nuevo Usuario -->
<div class="modal-overlay" *ngIf="showModal" (click)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h3>Nuevo Usuario</h3>
            <button class="btn-close" (click)="closeModal()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18" />
                    <line x1="6" y1="6" x2="18" y2="18" />
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <form (ngSubmit)="saveUser()">
                <div class="form-group">
                    <label>DNI</label>
                    <input type="text" [(ngModel)]="newUser.dni" name="dni" required class="form-input"
                        placeholder="12345678" maxlength="8" pattern="[0-9]{8}" 
                        (input)="onDniChange($event.target.value)">
                    <small *ngIf="searchingDni" style="color: #3b82f6;">üîç Buscando en RENIEC...</small>
                    <small *ngIf="nombresFromReniec" style="color: #10b981;">‚úì Datos obtenidos de RENIEC</small>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Nombre</label>
                        <input type="text" [(ngModel)]="newUser.nombre" name="nombre" required class="form-input"
                            placeholder="Ingrese el nombre" [readonly]="nombresFromReniec" 
                            [class.readonly-input]="nombresFromReniec">
                    </div>
                    <div class="form-group">
                        <label>Apellido</label>
                        <input type="text" [(ngModel)]="newUser.apellido" name="apellido" required class="form-input"
                            placeholder="Ingrese el apellido" [readonly]="nombresFromReniec"
                            [class.readonly-input]="nombresFromReniec">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" [(ngModel)]="newUser.email" name="email" required class="form-input"
                            placeholder="usuario@ejemplo.com" pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$">
                    </div>
                    <div class="form-group">
                        <label>Tel√©fono</label>
                        <input type="tel" [(ngModel)]="newUser.telefono" name="telefono" required class="form-input"
                            placeholder="999888777" maxlength="9" pattern="[0-9]{9}">
                    </div>
                </div>

                <div class="form-group">
                    <label>Rol</label>
                    <select [(ngModel)]="newUser.rol" name="rol" required class="form-input">
                        <option value="CLIENTE">Cliente</option>
                        <option value="EMPLEADO">Empleado</option>
                        <option value="ADMIN">Administrador</option>
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Contrase√±a</label>
                        <div style="position: relative;">
                            <input [type]="showPassword ? 'text' : 'password'" [(ngModel)]="newUser.password" 
                                name="password" required class="form-input" placeholder="M√≠nimo 6 caracteres" 
                                minlength="6" style="padding-right: 40px;">
                            <button type="button" (click)="togglePassword()" 
                                style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; padding: 5px;">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path *ngIf="!showPassword" d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                    <circle *ngIf="!showPassword" cx="12" cy="12" r="3"></circle>
                                    <path *ngIf="showPassword" d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
                                    <line *ngIf="showPassword" x1="1" y1="1" x2="23" y2="23"></line>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Confirmar Contrase√±a</label>
                        <div style="position: relative;">
                            <input [type]="showConfirmPassword ? 'text' : 'password'" [(ngModel)]="newUser.confirmPassword" 
                                name="confirmPassword" required class="form-input" placeholder="Confirme la contrase√±a" 
                                minlength="6" style="padding-right: 40px;">
                            <button type="button" (click)="toggleConfirmPassword()" 
                                style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; padding: 5px;">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path *ngIf="!showConfirmPassword" d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                    <circle *ngIf="!showConfirmPassword" cx="12" cy="12" r="3"></circle>
                                    <path *ngIf="showConfirmPassword" d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
                                    <line *ngIf="showConfirmPassword" x1="1" y1="1" x2="23" y2="23"></line>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn-secondary" (click)="closeModal()">Cancelar</button>
                    <button type="submit" class="btn-primary">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <polyline points="20 6 9 17 4 12" />
                        </svg>
                        Crear Usuario
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Editar Usuario -->
<div class="modal-overlay" *ngIf="showEditModal" (click)="closeEditModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h3>Editar Usuario</h3>
            <button class="btn-close" (click)="closeEditModal()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18" />
                    <line x1="6" y1="6" x2="18" y2="18" />
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <form (ngSubmit)="updateUser()">
                <div class="form-row">
                    <div class="form-group" style="position: relative;">
                        <label>DNI</label>
                        <input type="text" [(ngModel)]="editUser.dni" name="editDni" required class="form-input"
                            placeholder="12345678" pattern="[0-9]{8}" maxlength="8"
                            (input)="onEditDniChange($any($event.target).value)">
                        <small *ngIf="searchingEditDni" style="color: #666; font-size: 12px; display: block; margin-top: 4px;">
                            üîç Buscando en RENIEC...
                        </small>
                        <small *ngIf="nombresFromReniecEdit && !searchingEditDni" style="color: #10b981; font-size: 12px; display: block; margin-top: 4px;">
                            ‚úì Datos obtenidos de RENIEC
                        </small>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Nombre</label>
                        <input type="text" [(ngModel)]="editUser.nombre" name="editNombre" required class="form-input"
                            placeholder="Ingrese el nombre"
                            [readonly]="nombresFromReniecEdit"
                            [class.readonly-input]="nombresFromReniecEdit">
                    </div>
                    <div class="form-group">
                        <label>Apellido</label>
                        <input type="text" [(ngModel)]="editUser.apellido" name="editApellido" required class="form-input"
                            placeholder="Ingrese el apellido"
                            [readonly]="nombresFromReniecEdit"
                            [class.readonly-input]="nombresFromReniecEdit">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" [(ngModel)]="editUser.email" name="email" required class="form-input"
                            placeholder="usuario@ejemplo.com" pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$">
                    </div>
                    <div class="form-group">
                        <label>Tel√©fono</label>
                        <input type="tel" [(ngModel)]="editUser.telefono" name="telefono" required class="form-input"
                            placeholder="999888777" maxlength="9" pattern="[0-9]{9}">
                    </div>
                </div>

                <div class="form-group">
                    <label>Rol</label>
                    <select [(ngModel)]="editUser.rol" name="rol" required class="form-input">
                        <option value="CLIENTE">Cliente</option>
                        <option value="EMPLEADO">Empleado</option>
                        <option value="ADMIN">Administrador</option>
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Nueva Contrase√±a <small style="color: #6b7280;">(Dejar vac√≠o para no cambiar)</small></label>
                        <div style="position: relative;">
                            <input [type]="showEditPassword ? 'text' : 'password'" [(ngModel)]="editUser.password" 
                                name="password" class="form-input" placeholder="M√≠nimo 6 caracteres" 
                                minlength="6" style="padding-right: 40px;">
                            <button type="button" (click)="toggleEditPassword()" 
                                style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; padding: 5px;">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path *ngIf="!showEditPassword" d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                    <circle *ngIf="!showEditPassword" cx="12" cy="12" r="3"></circle>
                                    <path *ngIf="showEditPassword" d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
                                    <line *ngIf="showEditPassword" x1="1" y1="1" x2="23" y2="23"></line>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Confirmar Contrase√±a</label>
                        <div style="position: relative;">
                            <input [type]="showEditConfirmPassword ? 'text' : 'password'" [(ngModel)]="editUser.confirmPassword" 
                                name="confirmPassword" class="form-input" placeholder="Confirme la contrase√±a" 
                                minlength="6" style="padding-right: 40px;">
                            <button type="button" (click)="toggleEditConfirmPassword()" 
                                style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; padding: 5px;">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path *ngIf="!showEditConfirmPassword" d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                    <circle *ngIf="!showEditConfirmPassword" cx="12" cy="12" r="3"></circle>
                                    <path *ngIf="showEditConfirmPassword" d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
                                    <line *ngIf="showEditConfirmPassword" x1="1" y1="1" x2="23" y2="23"></line>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>



                <div class="modal-footer">
                    <button type="button" class="btn-secondary" (click)="closeEditModal()">Cancelar</button>
                    <button type="submit" class="btn-primary">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <polyline points="20 6 9 17 4 12" />
                        </svg>
                        Actualizar Usuario
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>