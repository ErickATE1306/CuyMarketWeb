<div class="dashboard-content">
    <div class="page-header">
        <h2>Gestión de Pedidos</h2>
        <button class="btn-primary" (click)="exportarReporte()">Exportar Reporte</button>
    </div>

    <!-- Stats -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="9" cy="21" r="1" />
                    <circle cx="20" cy="21" r="1" />
                    <path d="M1 1h4l2.68 12.39a2 2 0 0 0 2 1.61h7.72a2 2 0 0 0 2-1.61L23 6H6" />
                </svg>
            </div>
            <div class="stat-content">
                <span class="stat-label">Total Pedidos</span>
                <span class="stat-value">{{ estadisticas.totalPedidos }}</span>
            </div>
        </div>
        <div class="stat-card highlight">
            <div class="stat-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12" />
                </svg>
            </div>
            <div class="stat-content">
                <span class="stat-label">Pendientes</span>
                <span class="stat-value">{{ estadisticas.pendientes }}</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="20 6 9 17 4 12" />
                </svg>
            </div>
            <div class="stat-content">
                <span class="stat-label">Completados</span>
                <span class="stat-value">{{ estadisticas.completados }}</span>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="filters-bar">
        <div class="filter-group">
            <button class="filter-btn" [class.active]="filtroActivo === 'TODOS'" (click)="cambiarFiltro('TODOS')">
                Todos
            </button>
            <button class="filter-btn" [class.active]="filtroActivo === 'PENDIENTE'" (click)="cambiarFiltro('PENDIENTE')">
                Pendientes
            </button>
            <button class="filter-btn" [class.active]="filtroActivo === 'EN_PROCESO'" (click)="cambiarFiltro('EN_PROCESO')">
                En Proceso
            </button>
            <button class="filter-btn" [class.active]="filtroActivo === 'ENTREGADO'" (click)="cambiarFiltro('ENTREGADO')">
                Completados
            </button>
        </div>
        <div class="search-box">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8" />
                <path d="m21 21-4.35-4.35" />
            </svg>
            <input type="text" placeholder="Buscar pedido..." [(ngModel)]="searchTerm" (input)="buscar()">
        </div>
    </div>

    <!-- Loading -->
    <div *ngIf="loading" class="loading-container">
        <div class="spinner"></div>
        <p>Cargando pedidos...</p>
    </div>

    <!-- Orders Table -->
    <div class="table-card" *ngIf="!loading">
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Número</th>
                        <th>Cliente</th>
                        <th>Productos</th>
                        <th>Total</th>
                        <th>Fecha</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let pedido of filteredPedidos">
                        <td><strong>{{ pedido.numeroPedido }}</strong></td>
                        <td>
                            <div class="cliente-info">
                                <div>{{ pedido.usuarioNombre || 'Cliente' }}</div>
                                <small>{{ pedido.usuarioEmail }}</small>
                            </div>
                        </td>
                        <td>
                            <div class="productos-cell">
                                <span *ngIf="pedido.items.length === 1">
                                    {{ pedido.items[0].productoNombre }}
                                </span>
                                <span *ngIf="pedido.items.length > 1">
                                    {{ pedido.items[0].productoNombre }} <small>+{{ pedido.items.length - 1 }} más</small>
                                </span>
                            </div>
                        </td>
                        <td><strong>{{ formatearMoneda(pedido.total) }}</strong></td>
                        <td>{{ formatearFecha(pedido.fechaPedido) }}</td>
                        <td>
                            <span class="status-badge" [ngClass]="getEstadoBadgeClass(pedido.estado)">
                                {{ pedido.estado.replace('_', ' ') }}
                            </span>
                        </td>
                        <td>
                            <div class="actions-cell">
                                <button class="btn-icon" (click)="verDetalle(pedido)" title="Ver detalles">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" />
                                        <circle cx="12" cy="12" r="3" />
                                    </svg>
                                </button>
                                <select 
                                    class="estado-select" 
                                    [value]="pedido.estado"
                                    (change)="actualizarEstado(pedido.id, $any($event.target).value)"
                                    [disabled]="pedido.estado === 'ENTREGADO' || pedido.estado === 'CANCELADO'">
                                    <option value="PENDIENTE">Pendiente</option>
                                    <option value="EN_PROCESO">En Proceso</option>
                                    <option value="EN_CAMINO">En Camino</option>
                                    <option value="ENTREGADO">Entregado</option>
                                    <option value="CANCELADO">Cancelado</option>
                                </select>
                            </div>
                        </td>
                    </tr>
                    <tr *ngIf="filteredPedidos.length === 0">
                        <td colspan="7" class="empty-message">
                            No se encontraron pedidos
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal de Detalle -->
    <div class="modal-overlay" *ngIf="showDetalleModal" (click)="cerrarDetalle()">
        <div class="modal-content modal-detalle" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h3>Detalle del Pedido {{ pedidoSeleccionado?.numeroPedido }}</h3>
                <button class="modal-close" (click)="cerrarDetalle()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18" />
                        <line x1="6" y1="6" x2="18" y2="18" />
                    </svg>
                </button>
            </div>
            <div class="modal-body" *ngIf="pedidoSeleccionado">
                <div class="detalle-grid">
                    <div class="detalle-section">
                        <h4>Información General</h4>
                        <div class="info-row">
                            <span class="label">Fecha:</span>
                            <span>{{ formatearFecha(pedidoSeleccionado.fechaPedido) }}</span>
                        </div>
                        <div class="info-row">
                            <span class="label">Estado:</span>
                            <span class="status-badge" [ngClass]="getEstadoBadgeClass(pedidoSeleccionado.estado)">
                                {{ pedidoSeleccionado.estado.replace('_', ' ') }}
                            </span>
                        </div>
                        <div class="info-row" *ngIf="pedidoSeleccionado.metodoPago">
                            <span class="label">Método de Pago:</span>
                            <span>{{ pedidoSeleccionado.metodoPago }}</span>
                        </div>
                        <div class="info-row" *ngIf="pedidoSeleccionado.direccionEnvio">
                            <span class="label">Dirección:</span>
                            <span>{{ pedidoSeleccionado.direccionEnvio }}</span>
                        </div>
                    </div>

                    <div class="detalle-section">
                        <h4>Productos</h4>
                        <div class="items-list">
                            <div class="item-row" *ngFor="let item of pedidoSeleccionado.items">
                                <div class="item-info">
                                    <strong>{{ item.productoNombre }}</strong>
                                    <small *ngIf="item.productoRaza">{{ item.productoRaza }}</small>
                                </div>
                                <div class="item-cantidad">x{{ item.cantidad }}</div>
                                <div class="item-precio">{{ formatearMoneda(item.subtotal) }}</div>
                            </div>
                        </div>
                    </div>

                    <div class="detalle-section">
                        <h4>Resumen de Pago</h4>
                        <div class="info-row">
                            <span class="label">Subtotal:</span>
                            <span>{{ formatearMoneda(pedidoSeleccionado.subtotal) }}</span>
                        </div>
                        <div class="info-row" *ngIf="pedidoSeleccionado.descuento > 0">
                            <span class="label">Descuento:</span>
                            <span class="text-success">-{{ formatearMoneda(pedidoSeleccionado.descuento) }}</span>
                        </div>
                        <div class="info-row">
                            <span class="label">Costo de Envío:</span>
                            <span>{{ formatearMoneda(pedidoSeleccionado.costoEnvio) }}</span>
                        </div>
                        <div class="info-row total-row">
                            <span class="label"><strong>Total:</strong></span>
                            <span><strong>{{ formatearMoneda(pedidoSeleccionado.total) }}</strong></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>