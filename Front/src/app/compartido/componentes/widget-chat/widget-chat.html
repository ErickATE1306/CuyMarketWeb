<div class="chat-widget">
  <!-- Chat Button -->
  @if (!isOpen) {
    <button class="chat-button" (click)="toggleChat()" title="Chat en vivo">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
      </svg>
      @if (unreadCount > 0) {
        <span class="unread-badge">{{ unreadCount }}</span>
      }
    </button>
  }

  <!-- Chat Window -->
  @if (isOpen) {
    <div class="chat-window" [class.minimized]="isMinimized">
      <!-- Header -->
      <div class="chat-header">
        <div class="agent-info">
          <div class="agent-avatar">{{ agent.avatar }}</div>
          <div class="agent-details">
            <span class="agent-name">{{ agent.name }}</span>
            <span class="agent-status">
              <span class="status-dot" [class.online]="agent.status === 'online'"></span>
              {{ agent.status === 'online' ? 'En lÃ­nea' : 'Fuera de lÃ­nea' }}
            </span>
          </div>
        </div>
        <div class="chat-actions">
          <button (click)="isMinimized = !isMinimized" class="action-btn" [title]="isMinimized ? 'Restaurar' : 'Minimizar'">
            @if (isMinimized) {
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="18 15 12 9 6 15"/>
              </svg>
            } @else {
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="5" y1="12" x2="19" y2="12"/>
              </svg>
            }
          </button>
          <button (click)="toggleChat()" class="action-btn" title="Cerrar">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"/>
              <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
          </button>
        </div>
      </div>

      <!-- Messages -->
      @if (!isMinimized) {
        <div class="chat-messages" #messagesContainer>
          @if (messages.length === 0) {
            <div class="welcome-message">
              <div class="welcome-icon">ğŸ‘‹</div>
              <h3>Â¡Hola! Bienvenido a CuyMarket</h3>
              <p>Â¿En quÃ© podemos ayudarte hoy?</p>
            </div>
          }

          @for (message of messages; track message.id) {
            <div class="message" [class.user]="message.sender === 'user'" [class.agent]="message.sender === 'agent'">
              @if (message.sender === 'agent') {
                <div class="message-avatar">{{ agent.avatar }}</div>
              }
              <div class="message-content">
                <div class="message-bubble">{{ message.text }}</div>
                <div class="message-time">{{ formatTime(message.timestamp) }}</div>
              </div>
            </div>
          }

          @if (isTyping) {
            <div class="typing-indicator">
              <div class="message-avatar">{{ agent.avatar }}</div>
              <div class="typing-dots">
                <span></span>
                <span></span>
                <span></span>
              </div>
            </div>
          }
        </div>

        <!-- Input -->
        <div class="chat-input-container">
          <input
            type="text"
            [(ngModel)]="newMessage"
            (keyup.enter)="sendMessage()"
            placeholder="Escribe tu mensaje..."
            class="chat-input"
            [disabled]="isTyping"
          >
          <button 
            (click)="sendMessage()" 
            class="send-button"
            [disabled]="!newMessage.trim() || isTyping"
            title="Enviar mensaje"
          >
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="22" y1="2" x2="11" y2="13"/>
              <polygon points="22 2 15 22 11 13 2 9 22 2"/>
            </svg>
          </button>
        </div>

        <!-- Footer -->
        <div class="chat-footer">
          <button (click)="clearChat()" class="clear-btn">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="3 6 5 6 21 6"/>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
            </svg>
            Limpiar chat
          </button>
        </div>
      }
    </div>
  }
</div>
